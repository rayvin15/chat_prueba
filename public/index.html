<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Pro v7: Final Feature</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        .flex-1 { min-height: 0; }
        .unseen-status-border { border-color: #a855f7; }
        #message-context-menu { position: fixed; z-index: 1000; }
        .message-status-ticks { font-size: 0.9rem; }
        .ticks-read { color: #60a5fa; } /* Tailwind's blue-400 */
    </style>
</head>
<body class="bg-gray-900 text-white font-sans overflow-hidden">

    <!-- Vista de Login / Registro -->
    <div id="auth-view" class="flex items-center justify-center h-screen"><div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-2xl font-bold text-center mb-6">Bienvenido</h2><form id="auth-form" class="space-y-4"><input type="text" id="username" placeholder="Nombre de usuario" class="w-full bg-gray-700 p-3 rounded" required><input type="password" id="password" placeholder="Contraseña (mín. 6 caracteres)" class="w-full bg-gray-700 p-3 rounded" required><div class="flex gap-4"><button type="submit" name="action" value="login" class="w-full bg-indigo-600 p-3 rounded font-bold hover:bg-indigo-700 transition-colors">Iniciar Sesión</button><button type="submit" name="action" value="register" class="w-full bg-green-600 p-3 rounded font-bold hover:bg-green-700 transition-colors">Registrar</button></div></form><p id="auth-error" class="text-red-400 text-center mt-4 h-5"></p></div></div>

    <!-- Vista Principal del Chat -->
    <div id="chat-view" class="hidden h-screen flex">
        <!-- Barra Lateral -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 p-4 flex flex-col border-r border-gray-700"><div id="user-profile" class="mb-4 text-center"></div><div class="mb-4"><h3 class="text-lg font-bold mb-2">Estados</h3><div id="status-list" class="flex gap-3 overflow-x-auto pb-2"><div id="add-status-btn" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 bg-gray-700 rounded-full cursor-pointer text-2xl hover:bg-gray-600 transition-colors">+</div><input id="status-upload" type="file" accept="image/*,video/*" class="hidden"></div></div><div id="requests-section" class="mb-4"><h3 class="text-lg font-bold mb-2">Solicitudes</h3><ul id="request-list" class="space-y-2 max-h-32 overflow-y-auto"></ul></div><h3 class="text-lg font-bold mb-2">Amigos</h3><ul id="friend-list" class="flex-1 overflow-y-auto mb-4"></ul><div class="mt-auto"><div class="relative"><input type="text" id="search-user" placeholder="Buscar usuario..." class="w-full bg-gray-700 p-2 rounded"><ul id="search-results" class="absolute bottom-full mb-1 w-full bg-gray-600 rounded max-h-48 overflow-y-auto z-10"></ul></div><button id="logout-btn" class="mt-4 w-full bg-red-600 p-2 rounded font-bold hover:bg-red-700 transition-colors">Cerrar Sesión</button></div></aside>

        <!-- Área Principal del Chat -->
        <main class="w-full md:w-2/3 lg:w-3/4 flex flex-col h-screen bg-gray-900"><div id="chat-welcome" class="flex-1 flex items-center justify-center text-gray-500 text-center p-4"><p>Selecciona un amigo para comenzar a chatear.</p></div><div id="chat-area" class="hidden flex-1 flex-col overflow-hidden"><header id="chat-header" class="bg-gray-800 p-4 font-bold border-b border-gray-700 flex justify-between items-center"></header><ul id="messages" class="flex-1 p-4 space-y-4 overflow-y-auto"></ul><div id="emoji-picker-container" class="hidden absolute bottom-20 right-4 z-10"><emoji-picker class="dark"></emoji-picker></div><form id="message-form" class="bg-gray-800 p-4 flex items-center gap-2 border-t border-gray-700"><div class="relative flex-1"><input id="input" placeholder="Escribe un mensaje..." class="bg-gray-700 p-2 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"><button id="emoji-btn" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-xl hover:scale-110 transition-transform">😀</button></div><label for="file-upload" class="bg-gray-600 p-2 rounded-md cursor-pointer hover:bg-gray-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg></label><input id="file-upload" type="file" class="hidden"><button id="record-voice-btn" type="button" class="bg-gray-600 p-2 rounded-md hover:bg-gray-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button><button type="submit" class="bg-indigo-600 font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Enviar</button></form></div></main>
    </div>

    <!-- Modales y Menú Contextual -->
    <div id="incoming-call-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 p-8 rounded-lg text-center"><h3 id="incoming-call-from" class="text-2xl mb-4"></h3><p id="incoming-call-type" class="mb-6"></p><div class="flex gap-4"><button id="accept-call-btn" class="bg-green-600 px-6 py-2 rounded font-bold">Aceptar</button><button id="reject-call-btn" class="bg-red-600 px-6 py-2 rounded font-bold">Rechazar</button></div></div></div>
    <div id="call-view" class="hidden fixed inset-0 bg-gray-900 z-40 flex flex-col items-center justify-center p-4"><div class="relative w-full h-full flex items-center justify-center"><video id="remote-video" autoplay playsinline class="w-full h-full object-cover"></video><video id="local-video" autoplay playsinline muted class="absolute bottom-4 right-4 w-1/4 max-w-xs border-2 border-white rounded-md"></video></div><button id="end-call-btn" class="absolute bottom-10 bg-red-600 p-4 rounded-full font-bold">Colgar</button></div>
    <div id="status-viewer" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center z-50"><button id="close-status-viewer" class="absolute top-4 right-4 text-white text-3xl">&times;</button><div id="status-content" class="max-w-md max-h-[90vh]"></div><div id="status-viewers-list" class="text-xs text-gray-400 mt-2"></div></div>
    <div id="message-context-menu" class="hidden bg-gray-700 rounded-md shadow-lg py-1"><button id="delete-for-me-btn" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600">Eliminar para mí</button><button id="delete-for-all-btn" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600">Eliminar para todos</button></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const dom = { auth: { view: document.getElementById('auth-view'), form: document.getElementById('auth-form'), error: document.getElementById('auth-error') }, chat: { view: document.getElementById('chat-view'), welcome: document.getElementById('chat-welcome'), area: document.getElementById('chat-area'), header: document.getElementById('chat-header'), messages: document.getElementById('messages'), form: document.getElementById('message-form'), input: document.getElementById('input') }, sidebar: { profile: document.getElementById('user-profile'), logoutBtn: document.getElementById('logout-btn'), friendList: document.getElementById('friend-list'), searchUser: document.getElementById('search-user'), searchResults: document.getElementById('search-results'), requestList: document.getElementById('request-list') }, media: { fileUpload: document.getElementById('file-upload'), emojiBtn: document.getElementById('emoji-btn'), emojiPicker: document.getElementById('emoji-picker-container'), recordBtn: document.getElementById('record-voice-btn') }, call: { view: document.getElementById('call-view'), modal: document.getElementById('incoming-call-modal'), from: document.getElementById('incoming-call-from'), type: document.getElementById('incoming-call-type'), acceptBtn: document.getElementById('accept-call-btn'), rejectBtn: document.getElementById('reject-call-btn'), endBtn: document.getElementById('end-call-btn'), localVideo: document.getElementById('local-video'), remoteVideo: document.getElementById('remote-video') }, status: { list: document.getElementById('status-list'), addBtn: document.getElementById('add-status-btn'), upload: document.getElementById('status-upload'), viewer: document.getElementById('status-viewer'), content: document.getElementById('status-content'), closeBtn: document.getElementById('close-status-viewer'), viewersList: document.getElementById('status-viewers-list') }, contextMenu: { menu: document.getElementById('message-context-menu'), forMe: document.getElementById('delete-for-me-btn'), forAll: document.getElementById('delete-for-all-btn') } };
        let socket, currentChatFriend = null, currentUser = {};

        const api = { async call(endpoint, method = 'GET', body = null) { const token = localStorage.getItem('token'); const options = { method, headers: { 'Authorization': `Bearer ${token}` } }; if (body) { if (body instanceof FormData) { options.body = body; } else { options.headers['Content-Type'] = 'application/json'; options.body = JSON.stringify(body); } } const res = await fetch(endpoint, options); if (!res.ok) throw new Error(await res.text()); return res.headers.get('Content-Type')?.includes('json') ? res.json() : res.text(); } };

        dom.auth.form.addEventListener('submit', async e => { e.preventDefault(); const action = e.submitter.value; const username = document.getElementById('username').value; const password = document.getElementById('password').value; dom.auth.error.textContent = ''; try { if (action === 'register') { await api.call('/api/auth/register', 'POST', { username, password }); alert('¡Registro exitoso! Ahora inicia sesión.'); dom.auth.form.reset(); } else { const data = await api.call('/api/auth/login', 'POST', { username, password }); localStorage.setItem('token', data.accessToken); localStorage.setItem('userId', data.userId); localStorage.setItem('username', data.username); initChat(); } } catch (err) { dom.auth.error.textContent = err.message; } });
        dom.sidebar.logoutBtn.addEventListener('click', () => { localStorage.clear(); if (socket) socket.disconnect(); location.reload(); });
        function initChat() { dom.auth.view.classList.add('hidden'); dom.chat.view.classList.remove('hidden'); const token = localStorage.getItem('token'); socket = io({ auth: { token } }); currentUser = { id: localStorage.getItem('userId'), username: localStorage.getItem('username') }; dom.sidebar.profile.innerHTML = `Conectado como: <span class="font-bold">${currentUser.username}</span>`; loadAllData(); setupSocketListeners(); }
        async function loadAllData() { loadUserData(); loadFriendRequests(); loadStatuses(); }
        if (localStorage.getItem('token')) { initChat(); }
        
        async function loadUserData() { const user = await api.call('/api/me/data'); dom.sidebar.friendList.innerHTML = ''; user.friends.forEach(friend => { const li = document.createElement('li'); li.className = 'p-2 hover:bg-gray-700 cursor-pointer rounded flex justify-between items-center'; li.dataset.friendId = friend._id; li.innerHTML = `<div class="flex items-center gap-2"><div class="status-indicator w-2 h-2 bg-gray-500 rounded-full"></div><span class="flex-1">${friend.username}</span></div><div class="flex gap-2"><button class="call-btn-audio text-xl">📞</button><button class="call-btn-video text-xl">📹</button></div>`; li.querySelector('.flex-1').onclick = () => startChat(friend); li.querySelector('.call-btn-audio').onclick = (e) => { e.stopPropagation(); startCall(friend, false); }; li.querySelector('.call-btn-video').onclick = (e) => { e.stopPropagation(); startCall(friend, true); }; dom.sidebar.friendList.appendChild(li); }); socket.emit('get online friends'); }
        function startChat(friend) { currentChatFriend = friend; dom.chat.welcome.classList.add('hidden'); dom.chat.area.style.display = 'flex'; dom.chat.header.innerHTML = `<span>Chat con ${friend.username}</span><div class="online-status-header text-xs text-gray-400">Offline</div>`; dom.chat.messages.innerHTML = ''; socket.emit('join chat', friend._id); const friendLi = document.querySelector(`li[data-friend-id="${friend._id}"]`); const statusIndicator = friendLi.querySelector('.status-indicator'); if(statusIndicator.classList.contains('bg-green-400')) { document.querySelector('.online-status-header').textContent = 'Online'; } }
        async function loadFriendRequests() { const requests = await api.call('/api/friends/requests'); dom.sidebar.requestList.innerHTML = ''; requests.forEach(req => { const li = document.createElement('li'); li.className = 'p-2 bg-gray-700 rounded flex justify-between items-center text-sm'; li.innerHTML = `<span>${req.requester.username}</span><div class="flex gap-2"><button class="accept-btn text-green-400">✓</button><button class="decline-btn text-red-400">✗</button></div>`; li.querySelector('.accept-btn').onclick = () => respondToRequest(req._id, 'accepted'); li.querySelector('.decline-btn').onclick = () => respondToRequest(req._id, 'declined'); dom.sidebar.requestList.appendChild(li); }); }
        async function respondToRequest(requestId, status) { await api.call('/api/friends/response', 'POST', { requestId, status }); loadFriendRequests(); if (status === 'accepted') loadUserData(); }
        let searchTimeout; dom.sidebar.searchUser.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(async () => { const query = dom.sidebar.searchUser.value.trim(); if (query.length < 2) { dom.sidebar.searchResults.innerHTML = ''; return; } const users = await api.call(`/api/users/search?query=${query}`); dom.sidebar.searchResults.innerHTML = ''; users.forEach(user => { const li = document.createElement('li'); li.textContent = `+ ${user.username}`; li.className = 'p-2 text-sm text-green-400 hover:bg-gray-500 cursor-pointer'; li.onclick = () => sendFriendRequest(user._id); dom.sidebar.searchResults.appendChild(li); }); }, 300); });
        async function sendFriendRequest(recipientId) { try { await api.call('/api/friends/request', 'POST', { recipientId }); alert('Solicitud enviada!'); dom.sidebar.searchUser.value = ''; dom.sidebar.searchResults.innerHTML = ''; } catch (err) { alert(err.message); } }
        
        function updateOnlineStatus(userId, isOnline) { const friendLi = document.querySelector(`li[data-friend-id="${userId}"]`); if (friendLi) { const indicator = friendLi.querySelector('.status-indicator'); indicator.classList.toggle('bg-green-400', isOnline); indicator.classList.toggle('bg-gray-500', !isOnline); } if (currentChatFriend && currentChatFriend._id === userId) { document.querySelector('.online-status-header').textContent = isOnline ? 'Online' : 'Offline'; } }
        
        function setupSocketListeners() { socket.on('connect_error', err => { if (err.message.includes('Authentication')) dom.sidebar.logoutBtn.click(); }); socket.on('load history', data => { dom.chat.messages.innerHTML = ''; data.messages.forEach(msg => displayMessage(msg)); setTimeout(() => dom.chat.messages.scrollTop = dom.chat.messages.scrollHeight, 50); }); socket.on('chat message', msg => { const isAtBottom = dom.chat.messages.scrollHeight - dom.chat.messages.scrollTop <= dom.chat.messages.clientHeight + 50; if (currentChatFriend && (msg.sender._id === currentChatFriend._id || msg.sender._id === currentUser.id)) { displayMessage(msg); } if(isAtBottom) { setTimeout(() => dom.chat.messages.scrollTop = dom.chat.messages.scrollHeight, 0); } }); socket.on('message deleted', data => { const msgEl = document.querySelector(`[data-id="${data.messageId}"]`); if (msgEl) msgEl.remove(); }); socket.on('new friend request', () => { alert('¡Nueva solicitud de amistad!'); loadFriendRequests(); }); socket.on('friend request accepted', () => { alert('¡Tu solicitud de amistad fue aceptada!'); loadUserData(); }); socket.on('online friends list', onlineIds => onlineIds.forEach(id => updateOnlineStatus(id, true))); socket.on('friend online', userId => updateOnlineStatus(userId, true)); socket.on('friend offline', userId => updateOnlineStatus(userId, false)); socket.on('messages read', ({ messageIds }) => messageIds.forEach(id => { const el = document.querySelector(`[data-id="${id}"] .message-status-ticks`); if(el) el.classList.add('ticks-read'); })); socket.on('call-made', handleCallMade); socket.on('answer-made', handleAnswerMade); socket.on('ice-candidate', handleIceCandidate); socket.on('call-rejected', () => { alert("Llamada rechazada."); closeCall(); }); socket.on('call-ended', () => { alert("Llamada finalizada."); closeCall(); }); }
        dom.chat.form.addEventListener('submit', e => { e.preventDefault(); if (dom.chat.input.value && currentChatFriend) { socket.emit('chat message', { friendId: currentChatFriend._id, message: { text: dom.chat.input.value } }); dom.chat.input.value = ''; } });
        dom.media.fileUpload.addEventListener('change', async e => { const file = e.target.files[0]; if (!file || !currentChatFriend) return; const formData = new FormData(); formData.append('file', file); try { const data = await api.call('/upload', 'POST', formData); socket.emit('chat message', { friendId: currentChatFriend._id, message: { type: data.type, url: data.url } }); } catch (err) { alert('No se pudo subir el archivo.'); } finally { dom.media.fileUpload.value = ''; } });
        function displayMessage(msg) { const item = document.createElement('li'); const isOwnMessage = msg.sender._id === currentUser.id; item.dataset.id = msg._id; item.dataset.senderId = msg.sender._id; let content = msg.type === 'image' ? `<img src="${msg.url}" class="max-w-[250px] md:max-w-xs rounded-md mt-1 cursor-pointer" onclick="window.open(this.src, '_blank')">` : msg.type === 'video' ? `<video src="${msg.url}" controls class="max-w-[250px] md:max-w-xs rounded-md mt-1"></video>` : `<p class="text-white break-words">${msg.text}</p>`; const statusTicks = isOwnMessage ? `<span class="message-status-ticks text-xs ml-2 ${msg.status === 'read' ? 'ticks-read' : ''}">${msg.status === 'sent' ? '✓' : '✓✓'}</span>` : ''; item.className = `flex flex-col w-fit max-w-lg p-2 rounded-lg cursor-context-menu ${isOwnMessage ? 'self-end bg-indigo-600' : 'self-start bg-gray-700'}`; item.innerHTML = `${!isOwnMessage ? `<span class="font-bold text-xs text-gray-400">${msg.sender.username}</span>` : ''}<div class="flex items-end">${content}${statusTicks}</div>`; dom.chat.messages.appendChild(item); }
        
        let mediaRecorder, audioChunks = [];
        dom.media.recordBtn.addEventListener('mousedown', async () => { if (!currentChatFriend) return alert("Selecciona un chat primero."); try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); mediaRecorder.start(); dom.media.recordBtn.classList.add('bg-red-600', 'animate-pulse'); dom.media.recordBtn.classList.remove('hover:bg-gray-500'); mediaRecorder.ondataavailable = e => audioChunks.push(e.data); mediaRecorder.onstop = async () => { const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); const formData = new FormData(); formData.append('file', audioBlob, 'voice-note.webm'); try { const data = await api.call('/upload', 'POST', formData); socket.emit('chat message', { friendId: currentChatFriend._id, message: { type: 'video', url: data.url } }); } catch (err) { alert('No se pudo enviar la nota de voz.'); } audioChunks = []; stream.getTracks().forEach(t => t.stop()); }; } catch (err) { alert("No se pudo acceder al micrófono."); } });
        dom.media.recordBtn.addEventListener('mouseup', () => { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); dom.media.recordBtn.classList.remove('bg-red-600', 'animate-pulse'); dom.media.recordBtn.classList.add('hover:bg-gray-500'); } });
        
        dom.status.addBtn.addEventListener('click', () => dom.status.upload.click());
        async function loadStatuses() { const statusesByUser = await api.call('/api/statuses'); const statusListContainer = dom.status.list; while(statusListContainer.children.length > 1) { statusListContainer.removeChild(statusListContainer.lastChild); } statusesByUser.forEach(userStatus => { const statusCircle = document.createElement('div'); statusCircle.className = 'flex-shrink-0 flex flex-col items-center cursor-pointer'; const borderClass = userStatus.hasUnseen ? 'unseen-status-border border-2' : 'border-gray-600 border'; statusCircle.innerHTML = `<div class="w-16 h-16 rounded-full p-0.5 ${borderClass}"><div class="bg-gray-800 w-full h-full rounded-full p-1"><img src="https://ui-avatars.com/api/?name=${userStatus.owner.username.substring(0,2)}&background=random" class="rounded-full"></div></div><span class="text-xs mt-1">${userStatus.owner.username}</span>`; statusCircle.onclick = () => viewStatus(userStatus); statusListContainer.appendChild(statusCircle); }); }
        let currentStoryIndex = 0, currentStories = [];
        function viewStatus(userStatus) { currentStories = userStatus.stories; currentStoryIndex = 0; renderStory(); dom.status.viewer.classList.remove('hidden'); }
        async function renderStory() { const story = currentStories[currentStoryIndex]; if (!story) return dom.status.closeBtn.click(); if (!story.viewers.includes(currentUser.id)) await api.call(`/api/statuses/${story._id}/view`, 'POST'); if (story.type === 'image') { dom.status.content.innerHTML = `<img src="${story.url}" class="max-h-[90vh] rounded-lg">`; } else { dom.status.content.innerHTML = `<video src="${story.url}" autoplay class="max-h-[90vh] rounded-lg"></video>`; dom.status.content.querySelector('video').onended = nextStory; } const viewersRes = story.viewers.length > 0 ? `${story.viewers.length} vista(s)` : 'Nadie ha visto esto aún.'; dom.status.viewersList.textContent = viewersRes; }
        function nextStory() { currentStoryIndex++; renderStory(); }
        dom.status.viewer.addEventListener('click', e => { if (e.target.id === 'status-viewer') dom.status.closeBtn.click(); else if (e.target.tagName !== 'VIDEO') nextStory(); });
        dom.status.closeBtn.onclick = () => { dom.status.viewer.classList.add('hidden'); dom.status.content.innerHTML = ''; loadStatuses(); };
        dom.status.upload.addEventListener('change', async e => { const file = e.target.files[0]; if (!file) return; const formData = new FormData(); formData.append('file', file); try { await api.call('/api/statuses', 'POST', formData); alert("Estado subido con éxito!"); loadStatuses(); } catch (err) { alert("Error al subir el estado."); } finally { dom.status.upload.value = ''; } });
        
        let peerConnection, localStream, remoteCaller = null;
        const peerConnectionConfig = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
        async function startCall(friend, hasVideo) { if (!navigator.mediaDevices) return alert("Tu navegador no soporta llamadas."); remoteCaller = friend; try { localStream = await navigator.mediaDevices.getUserMedia({ video: hasVideo, audio: true }); dom.call.localVideo.srcObject = localStream; dom.call.view.classList.remove('hidden'); dom.call.remoteVideo.classList.toggle('hidden', !hasVideo); createPeerConnection(); const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); socket.emit('call-user', { to: remoteCaller._id, offer, callType: hasVideo ? 'video' : 'audio' }); } catch (err) { console.error("Error al iniciar llamada:", err); alert('No se pudo acceder a la cámara/micrófono.'); } }
        function createPeerConnection() { peerConnection = new RTCPeerConnection(peerConnectionConfig); peerConnection.ontrack = e => { if (dom.call.remoteVideo.srcObject !== e.streams[0]) { dom.call.remoteVideo.srcObject = e.streams[0]; } }; localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream)); }
        async function handleCallMade(data) { remoteCaller = data.from; dom.call.from.textContent = `${remoteCaller.username}`; dom.call.type.textContent = `Te está haciendo una ${data.callType === 'video' ? 'videollamada' : 'llamada de voz'}`; dom.call.modal.classList.remove('hidden'); dom.call.acceptBtn.onclick = async () => { dom.call.modal.classList.add('hidden'); try { localStream = await navigator.mediaDevices.getUserMedia({ video: data.callType === 'video', audio: true }); dom.call.localVideo.srcObject = localStream; dom.call.view.classList.remove('hidden'); dom.call.remoteVideo.classList.toggle('hidden', data.callType === 'audio'); createPeerConnection(); await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); socket.emit('make-answer', { to: remoteCaller.id, answer }); } catch (err) { console.error("Error al responder llamada:", err); alert('No se pudo acceder a la cámara/micrófono para responder.'); } }; dom.call.rejectBtn.onclick = () => { socket.emit('reject-call', { to: remoteCaller.id }); dom.call.modal.classList.add('hidden'); remoteCaller = null; }; }
        async function handleAnswerMade(data) { if (peerConnection) await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); }
        function handleIceCandidate(data) { if (peerConnection && peerConnection.remoteDescription) { peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(e => console.error("Error adding ice candidate", e)); } }
        dom.call.endBtn.addEventListener('click', () => { if(remoteCaller) socket.emit('end-call', { to: remoteCaller._id || remoteCaller.id }); closeCall(); });
        function closeCall() { if (peerConnection) { peerConnection.close(); peerConnection = null; } if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; } dom.call.view.classList.add('hidden'); dom.call.localVideo.srcObject = null; dom.call.remoteVideo.srcObject = null; remoteCaller = null; }
        
        // --- Menús Contextuales y Emojis (CORREGIDO) ---
        dom.chat.messages.addEventListener('contextmenu', e => { e.preventDefault(); const messageEl = e.target.closest('li[data-id]'); if (!messageEl) return; const messageId = messageEl.dataset.id; const senderId = messageEl.dataset.senderId; dom.contextMenu.menu.style.top = `${e.clientY}px`; dom.contextMenu.menu.style.left = `${e.clientX}px`; dom.contextMenu.menu.classList.remove('hidden'); dom.contextMenu.forMe.onclick = () => { socket.emit('delete message', { messageId, mode: 'self' }); messageEl.remove(); }; dom.contextMenu.forAll.style.display = senderId === currentUser.id ? 'block' : 'none'; dom.contextMenu.forAll.onclick = () => { socket.emit('delete message', { messageId, mode: 'all' }); }; });
        document.addEventListener('click', (e) => { if (!dom.contextMenu.menu.contains(e.target)) dom.contextMenu.menu.classList.add('hidden'); if (!dom.media.emojiPicker.contains(e.target) && e.target !== dom.media.emojiBtn) dom.media.emojiPicker.classList.add('hidden'); });
        dom.media.emojiBtn.addEventListener('click', (e) => { e.stopPropagation(); dom.media.emojiPicker.classList.toggle('hidden'); });
        document.querySelector('emoji-picker').addEventListener('emoji-click', e => { dom.chat.input.value += e.detail.unicode; });

        // Intersection Observer para marcar mensajes como leídos
        const observer = new IntersectionObserver((entries) => {
            const unreadMessages = [];
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const messageEl = entry.target;
                    if (messageEl.dataset.senderId !== currentUser.id && !messageEl.dataset.isRead) {
                        unreadMessages.push(messageEl.dataset.id);
                        messageEl.dataset.isRead = true;
                    }
                }
            });
            if (unreadMessages.length > 0) {
                socket.emit('mark as read', { chatId: currentChatFriend._id, messageIds: unreadMessages });
            }
        }, { root: dom.chat.messages, threshold: 0.9 });
    </script>
</body>
</html>