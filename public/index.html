<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Pro: Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
        .flex-1 { min-height: 0; }
        .unseen-status-border { border: 3px solid #a855f7; }
        .online-indicator { background-color: #10b981; box-shadow: 0 0 0 2px #1f2937, 0 0 6px rgba(16, 185, 129, 0.6); }
        .offline-indicator { background-color: #6b7280; }
        #message-context-menu { position: fixed; z-index: 1000; }
        .message-status-ticks { font-size: 0.8rem; color: #9ca3af; transition: color 0.2s; }
        .ticks-read { color: #60a5fa !important; }
        .sidebar-item:hover .sidebar-item-actions { opacity: 1; }
        .sidebar-item-actions { opacity: 0; transition: opacity 0.2s ease; }
        .typing-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #60a5fa; animation: typing 1.4s infinite ease-in-out; }
        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }
        .message-bubble { word-wrap: break-word; word-break: break-word; hyphens: auto; }
        .connection-status { position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 8px 12px; border-radius: 6px; font-size: 0.875rem; font-weight: 500; transition: all 0.3s; }
        .connection-status.connected { background: #059669; color: white; }
        .connection-status.disconnected { background: #dc2626; color: white; }
        .connection-status.reconnecting { background: #d97706; color: white; }
        .toast { position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 12px 16px; border-radius: 8px; color: white; font-weight: 500; transform: translateX(400px); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.success { background: #059669; }
        .toast.error { background: #dc2626; }
        .toast.info { background: #0284c7; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans overflow-hidden">
    <!-- Indicador de conexi√≥n -->
    <div id="connection-status" class="connection-status connected">Conectado</div>

    <!-- Vista de Login / Registro -->
    <div id="auth-view" class="flex items-center justify-center h-screen"><div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-2xl font-bold text-center mb-6">Chat Pro</h2><form id="auth-form" class="space-y-4"><div><input type="text" id="username" placeholder="Nombre de usuario" class="w-full bg-gray-700 p-3 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required maxlength="20" minlength="3"><small class="text-gray-400 text-xs">3-20 caracteres</small></div><div><input type="password" id="password" placeholder="Contrase√±a" class="w-full bg-gray-700 p-3 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" required minlength="6"><small class="text-gray-400 text-xs">M√≠nimo 6 caracteres</small></div><div class="flex gap-4"><button type="submit" name="action" value="login" class="w-full bg-indigo-600 p-3 rounded font-bold hover:bg-indigo-700 transition-colors">Iniciar Sesi√≥n</button><button type="submit" name="action" value="register" class="w-full bg-green-600 p-3 rounded font-bold hover:bg-green-700 transition-colors">Registrar</button></div></form><p id="auth-error" class="text-red-400 text-center mt-4 min-h-[1.25rem] text-sm"></p></div></div>

    <!-- Vista Principal del Chat -->
    <div id="chat-view" class="hidden h-screen flex">
        <!-- Barra Lateral -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 p-4 flex flex-col border-r border-gray-700"><div id="user-profile" class="mb-4 text-center p-3 bg-gray-700 rounded-lg"><div id="user-avatar" class="w-12 h-12 bg-indigo-600 rounded-full mx-auto mb-2 flex items-center justify-center text-lg font-bold"></div><div id="user-name" class="font-semibold"></div><div id="user-status" class="text-xs text-gray-400">En l√≠nea</div></div><div class="mb-4"><h3 class="text-lg font-bold mb-2 flex items-center gap-2"><span>Estados</span><span id="status-count" class="text-xs bg-gray-600 px-2 py-1 rounded-full">0</span></h3><div id="status-list" class="flex gap-3 overflow-x-auto pb-2"><div id="add-status-btn" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 bg-gray-700 rounded-full cursor-pointer text-2xl hover:bg-gray-600 transition-colors">+</div><input id="status-upload" type="file" accept="image/*,video/*" class="hidden"></div></div><div id="requests-section" class="mb-4"><h3 class="text-lg font-bold mb-2 flex items-center gap-2"><span>Solicitudes</span><span id="requests-count" class="text-xs bg-red-600 px-2 py-1 rounded-full hidden">0</span></h3><ul id="request-list" class="space-y-2 max-h-32 overflow-y-auto"></ul></div><div class="flex justify-between items-center mb-2"><h3 class="text-lg font-bold">Chats</h3><button id="create-group-btn" class="text-2xl hover:text-indigo-400 transition-colors" title="Crear grupo">+</button></div><ul id="chat-list" class="flex-1 overflow-y-auto mb-4 space-y-1"></ul><div class="mt-auto space-y-3"><div class="relative"><input type="text" id="search-user" placeholder="Buscar usuario..." class="w-full bg-gray-700 p-2 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"><ul id="search-results" class="absolute bottom-full mb-1 w-full bg-gray-600 rounded max-h-48 overflow-y-auto z-10 shadow-lg"></ul></div><button id="logout-btn" class="w-full bg-red-600 p-2 rounded font-bold hover:bg-red-700 transition-colors">Cerrar Sesi√≥n</button></div></aside>

        <!-- √Årea Principal del Chat -->
        <main class="w-full md:w-2/3 lg:w-3/4 flex flex-col h-screen bg-gray-900"><div id="chat-welcome" class="flex-1 flex items-center justify-center text-gray-500 text-center p-4"><div><div class="text-6xl mb-4">üí¨</div><p class="text-xl mb-2">Bienvenido a Chat Pro</p><p>Selecciona un chat para comenzar a conversar</p></div></div><div id="chat-area" class="hidden flex-1 flex-col overflow-hidden"><header id="chat-header" class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center"><div class="flex items-center gap-3"><div id="chat-avatar" class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center font-bold"></div><div><div id="chat-name" class="font-bold"></div><div id="chat-status" class="text-xs text-gray-400"></div></div></div><div class="flex gap-2"><button id="chat-info-btn" class="p-2 hover:bg-gray-700 rounded transition-colors">‚ÑπÔ∏è</button></div></header><div class="flex-1 flex flex-col overflow-hidden"><ul id="messages" class="flex-1 p-4 space-y-3 overflow-y-auto scroll-smooth"></ul><div id="typing-indicator" class="hidden px-4 py-2"><div class="flex items-center gap-2 text-sm text-gray-400"><span id="typing-user"></span><span>est√° escribiendo</span><div class="flex gap-1"><div class="typing-indicator"></div><div class="typing-indicator"></div><div class="typing-indicator"></div></div></div></div></div><div id="emoji-picker-container" class="hidden absolute bottom-20 right-4 z-10"><emoji-picker class="dark"></emoji-picker></div><form id="message-form" class="bg-gray-800 p-4 flex items-center gap-2 border-t border-gray-700"><div class="relative flex-1"><input id="input" placeholder="Escribe un mensaje..." maxlength="1000" class="bg-gray-700 p-3 pr-12 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none" autocomplete="off"><button id="emoji-btn" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-xl hover:scale-110 transition-transform">üòÄ</button></div><label for="file-upload" class="bg-gray-600 p-3 rounded-md cursor-pointer hover:bg-gray-500 transition-colors" title="Subir archivo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg></label><input id="file-upload" type="file" class="hidden" accept="image/*,video/*,audio/*"><button id="record-voice-btn" type="button" title="Grabar nota de voz" class="bg-gray-600 p-3 rounded-md hover:bg-gray-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg></button><button type="submit" class="bg-indigo-600 font-bold py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors">Enviar</button></form></div></main>
    </div>

    <!-- Modales -->
    <div id="create-group-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 p-8 rounded-lg w-full max-w-md max-h-[90vh] overflow-y-auto"><h3 class="text-2xl mb-4">Crear Nuevo Grupo</h3><form id="create-group-form"><input type="text" id="group-name" placeholder="Nombre del grupo" maxlength="50" class="w-full bg-gray-700 p-3 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" required><textarea id="group-description" placeholder="Descripci√≥n (opcional)" maxlength="200" class="w-full bg-gray-700 p-3 rounded mb-4 h-20 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea><h4 class="mb-2">Seleccionar amigos:</h4><div id="group-friends-list" class="max-h-48 overflow-y-auto mb-4 border border-gray-700 p-3 rounded space-y-2"></div><div class="flex gap-4"><button type="submit" class="bg-indigo-600 px-6 py-2 rounded font-bold hover:bg-indigo-700 transition-colors">Crear</button><button type="button" id="cancel-group-creation" class="bg-gray-600 px-6 py-2 rounded font-bold hover:bg-gray-700 transition-colors">Cancelar</button></div></form></div></div>
    <div id="incoming-call-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50"><div class="bg-gray-800 p-8 rounded-lg text-center"><div class="mb-6"><div class="w-24 h-24 bg-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl font-bold animate-pulse">üìû</div><h3 id="incoming-call-from" class="text-2xl mb-2"></h3><p id="incoming-call-type" class="text-gray-400"></p></div><div class="flex gap-6 justify-center"><button id="accept-call-btn" class="bg-green-600 p-4 rounded-full hover:bg-green-700 transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/></svg></button><button id="reject-call-btn" class="bg-red-600 p-4 rounded-full hover:bg-red-700 transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div></div></div>
    <div id="call-view" class="hidden fixed inset-0 bg-gray-900 z-40 flex flex-col items-center justify-center p-4"><div class="relative w-full h-full flex items-center justify-center"><video id="remote-video" autoplay playsinline class="w-full h-full object-cover rounded-lg"></video><video id="local-video" autoplay playsinline muted class="absolute bottom-4 right-4 w-1/4 max-w-xs border-2 border-white rounded-md"></video></div><div class="absolute bottom-10 flex gap-4"><button id="mute-btn" class="bg-gray-600 p-4 rounded-full hover:bg-gray-500 transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.761L4.846 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.846l3.537-3.761a1 1 0 011.617.761z" clip-rule="evenodd"/></svg></button><button id="end-call-btn" class="bg-red-600 p-4 rounded-full font-bold hover:bg-red-700 transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/></svg></button></div></div>
    <div id="status-viewer" class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center z-50"><button id="close-status-viewer" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 transition-colors">&times;</button><div class="absolute top-4 left-4 text-white"><div id="status-owner-name" class="font-bold"></div><div id="status-time" class="text-sm text-gray-300"></div></div><div id="status-content" class="max-w-md max-h-[90vh] flex items-center justify-center"></div><div id="status-viewers-list" class="absolute bottom-4 left-4 text-xs text-gray-400"></div><div class="absolute bottom-4 right-4 text-white flex gap-2"><button id="prev-status" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors">‚Üê</button><button id="next-status" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors">‚Üí</button></div></div>
    <div id="message-context-menu" class="hidden bg-gray-700 rounded-md shadow-lg py-1 min-w-[120px]"><button id="reply-message-btn" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600 transition-colors">Responder</button><button id="delete-for-me-btn" class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-600 transition-colors">Eliminar para m√≠</button><button id="delete-for-all-btn" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600 transition-colors">Eliminar para todos</button></div>
    <div id="toast-container"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const dom = { auth: { view: document.getElementById('auth-view'), form: document.getElementById('auth-form'), error: document.getElementById('auth-error') }, chat: { view: document.getElementById('chat-view'), welcome: document.getElementById('chat-welcome'), area: document.getElementById('chat-area'), header: document.getElementById('chat-header'), messages: document.getElementById('messages'), form: document.getElementById('message-form'), input: document.getElementById('input') }, sidebar: { profile: document.getElementById('user-profile'), logoutBtn: document.getElementById('logout-btn'), chatList: document.getElementById('chat-list'), searchUser: document.getElementById('search-user'), searchResults: document.getElementById('search-results'), requestList: document.getElementById('request-list') }, media: { fileUpload: document.getElementById('file-upload'), emojiBtn: document.getElementById('emoji-btn'), emojiPicker: document.getElementById('emoji-picker-container'), recordBtn: document.getElementById('record-voice-btn') }, call: { view: document.getElementById('call-view'), modal: document.getElementById('incoming-call-modal'), from: document.getElementById('incoming-call-from'), type: document.getElementById('incoming-call-type'), acceptBtn: document.getElementById('accept-call-btn'), rejectBtn: document.getElementById('reject-call-btn'), endBtn: document.getElementById('end-call-btn'), localVideo: document.getElementById('local-video'), remoteVideo: document.getElementById('remote-video') }, status: { list: document.getElementById('status-list'), addBtn: document.getElementById('add-status-btn'), upload: document.getElementById('status-upload'), viewer: document.getElementById('status-viewer'), content: document.getElementById('status-content'), closeBtn: document.getElementById('close-status-viewer'), viewersList: document.getElementById('status-viewers-list') }, contextMenu: { menu: document.getElementById('message-context-menu'), forMe: document.getElementById('delete-for-me-btn'), forAll: document.getElementById('delete-for-all-btn') }, group: { createBtn: document.getElementById('create-group-btn'), modal: document.getElementById('create-group-modal'), form: document.getElementById('create-group-form'), nameInput: document.getElementById('group-name'), friendsList: document.getElementById('group-friends-list'), cancelBtn: document.getElementById('cancel-group-creation') } };
        let socket, currentChat = null, currentUser = {};

        const api = { async call(endpoint, method = 'GET', body = null) { const token = localStorage.getItem('token'); const options = { method, headers: { 'Authorization': `Bearer ${token}` } }; if (body) { if (body instanceof FormData) { options.body = body; } else { options.headers['Content-Type'] = 'application/json'; options.body = JSON.stringify(body); } } const res = await fetch(endpoint, options); if (!res.ok) throw new Error(await res.text()); return res.headers.get('Content-Type')?.includes('json') ? res.json() : res.text(); } };

        dom.auth.form.addEventListener('submit', async e => { e.preventDefault(); const action = e.submitter.value; const username = document.getElementById('username').value; const password = document.getElementById('password').value; dom.auth.error.textContent = ''; try { if (action === 'register') { await api.call('/api/auth/register', 'POST', { username, password }); alert('¬°Registro exitoso! Ahora inicia sesi√≥n.'); dom.auth.form.reset(); } else { const data = await api.call('/api/auth/login', 'POST', { username, password }); localStorage.setItem('token', data.accessToken); localStorage.setItem('userId', data.userId); localStorage.setItem('username', data.username); initChat(); } } catch (err) { dom.auth.error.textContent = err.message; } });
        dom.sidebar.logoutBtn.addEventListener('click', () => { localStorage.clear(); if (socket) socket.disconnect(); location.reload(); });
        function initChat() { dom.auth.view.classList.add('hidden'); dom.chat.view.classList.remove('hidden'); const token = localStorage.getItem('token'); socket = io({ auth: { token } }); currentUser = { id: localStorage.getItem('userId'), username: localStorage.getItem('username') }; dom.sidebar.profile.innerHTML = `Conectado como: <span class="font-bold">${currentUser.username}</span>`; loadAllData(); setupSocketListeners(); }
        async function loadAllData() { loadChats(); loadFriendRequests(); loadStatuses(); }
        if (localStorage.getItem('token')) { initChat(); }
        
        async function loadChats() { const chats = await api.call('/api/chats'); dom.sidebar.chatList.innerHTML = ''; chats.forEach(chat => { const li = document.createElement('li'); li.className = 'sidebar-item p-2 hover:bg-gray-700 cursor-pointer rounded flex justify-between items-center'; li.dataset.chatId = chat._id; let callButtons = ''; if (chat.type === 'private') { const friend = chat.participants[0]; li.dataset.friendId = friend._id; callButtons = `<div class="sidebar-item-actions flex gap-2 opacity-0 transition-opacity"><button class="call-btn-audio text-xl">üìû</button><button class="call-btn-video text-xl">üìπ</button></div>`; } li.innerHTML = `<div class="flex items-center gap-2"><div class="status-indicator w-2 h-2 bg-gray-500 rounded-full"></div><span class="flex-1">${chat.name}</span></div>${callButtons}`; li.querySelector('.flex-1').onclick = () => startChat(chat); if (chat.type === 'private') { const friend = chat.participants[0]; li.querySelector('.call-btn-audio').onclick = (e) => { e.stopPropagation(); startCall(friend, false); }; li.querySelector('.call-btn-video').onclick = (e) => { e.stopPropagation(); startCall(friend, true); }; } dom.sidebar.chatList.appendChild(li); }); socket.emit('get online friends'); }
        function startChat(chat) { currentChat = chat; dom.chat.welcome.classList.add('hidden'); dom.chat.area.style.display = 'flex'; dom.chat.header.innerHTML = `<span>Chat con ${chat.name}</span>`; dom.chat.messages.innerHTML = ''; socket.emit('join chat', chat._id); if (chat.type === 'private') { const friendLi = document.querySelector(`li[data-friend-id="${chat.participants[0]._id}"]`); const statusIndicator = friendLi.querySelector('.status-indicator'); if(statusIndicator.classList.contains('bg-green-400')) { document.querySelector('.online-status-header').textContent = 'Online'; } } }
        async function loadFriendRequests() { const requests = await api.call('/api/friends/requests'); dom.sidebar.requestList.innerHTML = ''; requests.forEach(req => { const li = document.createElement('li'); li.className = 'p-2 bg-gray-700 rounded flex justify-between items-center text-sm'; li.innerHTML = `<span>${req.requester.username}</span><div class="flex gap-2"><button class="accept-btn text-green-400">‚úì</button><button class="decline-btn text-red-400">‚úó</button></div>`; li.querySelector('.accept-btn').onclick = () => respondToRequest(req._id, 'accepted'); li.querySelector('.decline-btn').onclick = () => respondToRequest(req._id, 'declined'); dom.sidebar.requestList.appendChild(li); }); }
        async function respondToRequest(requestId, status) { await api.call('/api/friends/response', 'POST', { requestId, status }); loadFriendRequests(); if (status === 'accepted') loadChats(); }
        let searchTimeout; dom.sidebar.searchUser.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(async () => { const query = dom.sidebar.searchUser.value.trim(); if (query.length < 2) { dom.sidebar.searchResults.innerHTML = ''; return; } const users = await api.call(`/api/users/search?query=${query}`); dom.sidebar.searchResults.innerHTML = ''; users.forEach(user => { const li = document.createElement('li'); li.textContent = `+ ${user.username}`; li.className = 'p-2 text-sm text-green-400 hover:bg-gray-500 cursor-pointer'; li.onclick = () => sendFriendRequest(user._id); dom.sidebar.searchResults.appendChild(li); }); }, 300); });
        async function sendFriendRequest(recipientId) { try { await api.call('/api/friends/request', 'POST', { recipientId }); alert('Solicitud enviada!'); dom.sidebar.searchUser.value = ''; dom.sidebar.searchResults.innerHTML = ''; } catch (err) { alert(err.message); } }
        
        function updateOnlineStatus(userId, isOnline) { const friendLi = document.querySelector(`li[data-friend-id="${userId}"]`); if (friendLi) { const indicator = friendLi.querySelector('.status-indicator'); indicator.classList.toggle('bg-green-400', isOnline); indicator.classList.toggle('bg-gray-500', !isOnline); } if (currentChat && currentChat.type === 'private' && currentChat.participants[0]._id === userId) { document.querySelector('.online-status-header').textContent = isOnline ? 'Online' : 'Offline'; } }
        
        function setupSocketListeners() { socket.on('connect_error', err => { if (err.message.includes('Authentication')) dom.sidebar.logoutBtn.click(); }); socket.on('load history', data => { dom.chat.messages.innerHTML = ''; data.messages.forEach(msg => displayMessage(msg)); setTimeout(() => dom.chat.messages.scrollTop = dom.chat.messages.scrollHeight, 50); }); socket.on('chat message', msg => { const isAtBottom = dom.chat.messages.scrollHeight - dom.chat.messages.scrollTop <= dom.chat.messages.clientHeight + 50; if (currentChat && msg.chatId === currentChat._id) displayMessage(msg); if(isAtBottom) setTimeout(() => dom.chat.messages.scrollTop = dom.chat.messages.scrollHeight, 0); }); socket.on('message deleted', data => { const msgEl = document.querySelector(`[data-id="${data.messageId}"]`); if (msgEl) msgEl.remove(); }); socket.on('new friend request', () => { alert('¬°Nueva solicitud de amistad!'); loadFriendRequests(); }); socket.on('friend request accepted', () => { alert('¬°Tu solicitud fue aceptada!'); loadChats(); }); socket.on('added to group', () => { alert('¬°Te han a√±adido a un nuevo grupo!'); loadChats(); }); socket.on('online friends list', onlineIds => onlineIds.forEach(id => updateOnlineStatus(id, true))); socket.on('friend online', userId => updateOnlineStatus(userId, true)); socket.on('friend offline', userId => updateOnlineStatus(userId, false)); socket.on('messages read', ({ messageIds, readerId }) => { if (readerId !== currentUser.id) messageIds.forEach(id => { const el = document.querySelector(`[data-id="${id}"] .message-status-ticks`); if(el) el.classList.add('ticks-read'); }); }); socket.on('call-made', handleCallMade); socket.on('answer-made', handleAnswerMade); socket.on('ice-candidate', handleIceCandidate); socket.on('call-rejected', () => { alert("Llamada rechazada."); closeCall(); }); socket.on('call-ended', () => { alert("Llamada finalizada."); closeCall(); }); }
        dom.chat.form.addEventListener('submit', e => { e.preventDefault(); if (dom.chat.input.value && currentChat) { const messageData = { chatId: currentChat._id, message: { text: dom.chat.input.value } }; if(currentChat.type === 'private') messageData.friendId = currentChat.participants[0]._id; socket.emit('chat message', messageData); dom.chat.input.value = ''; } });
        dom.media.fileUpload.addEventListener('change', async e => { const file = e.target.files[0]; if (!file || !currentChat) return; const formData = new FormData(); formData.append('file', file); try { const data = await api.call('/upload', 'POST', formData); const messageData = { chatId: currentChat._id, message: { type: data.type, url: data.url } }; if(currentChat.type === 'private') messageData.friendId = currentChat.participants[0]._id; socket.emit('chat message', messageData); } catch (err) { alert('No se pudo subir el archivo.'); } finally { dom.media.fileUpload.value = ''; } });
        function displayMessage(msg) { const item = document.createElement('li'); const isOwnMessage = msg.sender._id === currentUser.id; item.dataset.id = msg._id; item.dataset.senderId = msg.sender._id; let content = msg.type === 'image' ? `<img src="${msg.url}" class="max-w-[250px] md:max-w-xs rounded-md mt-1 cursor-pointer" onclick="window.open(this.src, '_blank')">` : msg.type === 'video' ? `<video src="${msg.url}" controls class="max-w-[250px] md:max-w-xs rounded-md mt-1"></video>` : `<p class="text-white break-words">${msg.text}</p>`; const statusTicks = isOwnMessage ? `<span class="message-status-ticks text-xs ml-2 ${msg.status === 'read' ? 'ticks-read' : ''}">${msg.status === 'sent' ? '‚úì' : '‚úì‚úì'}</span>` : ''; item.className = `flex flex-col w-fit max-w-lg p-2 rounded-lg cursor-context-menu ${isOwnMessage ? 'self-end bg-indigo-600' : 'self-start bg-gray-700'}`; item.innerHTML = `${!isOwnMessage ? `<span class="font-bold text-xs text-gray-400">${msg.sender.username}</span>` : ''}<div class="flex items-end">${content}${statusTicks}</div>`; dom.chat.messages.appendChild(item); item.addEventListener('contextmenu', showContextMenu); }
        
        let mediaRecorder, audioChunks = [];
        dom.media.recordBtn.addEventListener('mousedown', async () => { if (!currentChat) return alert("Selecciona un chat primero."); try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); mediaRecorder.start(); dom.media.recordBtn.classList.add('bg-red-600', 'animate-pulse'); dom.media.recordBtn.classList.remove('hover:bg-gray-500'); mediaRecorder.ondataavailable = e => audioChunks.push(e.data); mediaRecorder.onstop = async () => { const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); const formData = new FormData(); formData.append('file', audioBlob, 'voice-note.webm'); try { const data = await api.call('/upload', 'POST', formData); const messageData = { chatId: currentChat._id, message: { type: 'video', url: data.url } }; if(currentChat.type === 'private') messageData.friendId = currentChat.participants[0]._id; socket.emit('chat message', messageData); } catch (err) { alert('No se pudo enviar la nota de voz.'); } audioChunks = []; stream.getTracks().forEach(t => t.stop()); }; } catch (err) { alert("No se pudo acceder al micr√≥fono."); } });
        dom.media.recordBtn.addEventListener('mouseup', () => { if (mediaRecorder && mediaRecorder.state === "recording") { mediaRecorder.stop(); dom.media.recordBtn.classList.remove('bg-red-600', 'animate-pulse'); dom.media.recordBtn.classList.add('hover:bg-gray-500'); } });
        
        dom.status.addBtn.addEventListener('click', () => dom.status.upload.click());
        async function loadStatuses() { const statusesByUser = await api.call('/api/statuses'); const statusListContainer = dom.status.list; while(statusListContainer.children.length > 1) { statusListContainer.removeChild(statusListContainer.lastChild); } statusesByUser.forEach(userStatus => { const statusCircle = document.createElement('div'); statusCircle.className = 'flex-shrink-0 flex flex-col items-center cursor-pointer'; const borderClass = userStatus.hasUnseen ? 'unseen-status-border border-2' : 'border-gray-600 border'; statusCircle.innerHTML = `<div class="w-16 h-16 rounded-full p-0.5 ${borderClass}"><div class="bg-gray-800 w-full h-full rounded-full p-1"><img src="https://ui-avatars.com/api/?name=${userStatus.owner.username.substring(0,2)}&background=random" class="rounded-full"></div></div><span class="text-xs mt-1">${userStatus.owner.username}</span>`; statusCircle.onclick = () => viewStatus(userStatus); statusListContainer.appendChild(statusCircle); }); }
        let currentStoryIndex = 0, currentStories = [];
        function viewStatus(userStatus) { currentStories = userStatus.stories; currentStoryIndex = 0; renderStory(); dom.status.viewer.classList.remove('hidden'); }
        async function renderStory() { const story = currentStories[currentStoryIndex]; if (!story) return dom.status.closeBtn.click(); if (!story.viewers.includes(currentUser.id)) await api.call(`/api/statuses/${story._id}/view`, 'POST'); if (story.type === 'image') { dom.status.content.innerHTML = `<img src="${story.url}" class="max-h-[90vh] rounded-lg">`; } else { dom.status.content.innerHTML = `<video src="${story.url}" autoplay class="max-h-[90vh] rounded-lg"></video>`; dom.status.content.querySelector('video').onended = nextStory; } const viewersRes = story.viewers.length > 0 ? `${story.viewers.length} vista(s)` : 'Nadie ha visto esto a√∫n.'; dom.status.viewersList.textContent = viewersRes; }
        function nextStory() { currentStoryIndex++; renderStory(); }
        dom.status.viewer.addEventListener('click', e => { if (e.target.id === 'status-viewer') dom.status.closeBtn.click(); else if (e.target.tagName !== 'VIDEO') nextStory(); });
        dom.status.closeBtn.onclick = () => { dom.status.viewer.classList.add('hidden'); dom.status.content.innerHTML = ''; loadStatuses(); };
        dom.status.upload.addEventListener('change', async e => { const file = e.target.files[0]; if (!file) return; const formData = new FormData(); formData.append('file', file); try { await api.call('/api/statuses', 'POST', formData); alert("Estado subido con √©xito!"); loadStatuses(); } catch (err) { alert("Error al subir el estado."); } finally { dom.status.upload.value = ''; } });
        
        let peerConnection, localStream, remoteCaller = null;
        const peerConnectionConfig = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
        async function startCall(friend, hasVideo) { if (!navigator.mediaDevices) return alert("Tu navegador no soporta llamadas."); remoteCaller = friend; try { localStream = await navigator.mediaDevices.getUserMedia({ video: hasVideo, audio: true }); dom.call.localVideo.srcObject = localStream; dom.call.view.classList.remove('hidden'); dom.call.remoteVideo.classList.toggle('hidden', !hasVideo); createPeerConnection(); const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer); socket.emit('call-user', { to: remoteCaller._id, offer, callType: hasVideo ? 'video' : 'audio' }); } catch (err) { console.error("Error al iniciar llamada:", err); alert('No se pudo acceder a la c√°mara/micr√≥fono.'); } }
        function createPeerConnection() { peerConnection = new RTCPeerConnection(peerConnectionConfig); peerConnection.ontrack = e => { if (dom.call.remoteVideo.srcObject !== e.streams[0]) { dom.call.remoteVideo.srcObject = e.streams[0]; } }; localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream)); }
        async function handleCallMade(data) { remoteCaller = data.from; dom.call.from.textContent = `${remoteCaller.username}`; dom.call.type.textContent = `Te est√° haciendo una ${data.callType === 'video' ? 'videollamada' : 'llamada de voz'}`; dom.call.modal.classList.remove('hidden'); dom.call.acceptBtn.onclick = async () => { dom.call.modal.classList.add('hidden'); try { localStream = await navigator.mediaDevices.getUserMedia({ video: data.callType === 'video', audio: true }); dom.call.localVideo.srcObject = localStream; dom.call.view.classList.remove('hidden'); dom.call.remoteVideo.classList.toggle('hidden', data.callType === 'audio'); createPeerConnection(); await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer)); const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer); socket.emit('make-answer', { to: remoteCaller.id, answer }); } catch (err) { console.error("Error al responder llamada:", err); alert('No se pudo acceder a la c√°mara/micr√≥fono para responder.'); } }; dom.call.rejectBtn.onclick = () => { socket.emit('reject-call', { to: remoteCaller.id }); dom.call.modal.classList.add('hidden'); remoteCaller = null; }; }
        async function handleAnswerMade(data) { if (peerConnection) await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); }
        function handleIceCandidate(data) { if (peerConnection && peerConnection.remoteDescription) { peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(e => console.error("Error adding ice candidate", e)); } }
        dom.call.endBtn.addEventListener('click', () => { if(remoteCaller) socket.emit('end-call', { to: remoteCaller._id || remoteCaller.id }); closeCall(); });
        

        function closeCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            dom.call.view.classList.add('hidden');
            dom.call.localVideo.srcObject = null;
            dom.call.remoteVideo.srcObject = null;
            remoteCaller = null;
        }

        // --- Men√∫s Contextuales y Emojis (CORREGIDO) ---
        function showContextMenu(e, msg) {
            e.preventDefault();
            
            const menu = dom.contextMenu.menu;
            menu.style.top = `${e.clientY}px`;
            menu.style.left = `${e.clientX}px`;
            menu.classList.remove('hidden');

            const messageEl = e.currentTarget;

            // Eliminar para m√≠
            dom.contextMenu.forMe.onclick = () => {
                socket.emit('delete message', { messageId: msg._id, mode: 'self' });
                messageEl.remove(); // Eliminaci√≥n optimista
                menu.classList.add('hidden');
            };

            // Eliminar para todos
            if (msg.sender._id === currentUser.id) {
                dom.contextMenu.forAll.style.display = 'block';
                dom.contextMenu.forAll.onclick = () => {
                    socket.emit('delete message', { messageId: msg._id, mode: 'all' });
                    menu.classList.add('hidden');
                };
            } else {
                dom.contextMenu.forAll.style.display = 'none';
            }
        }

        document.addEventListener('click', (e) => {
            // Cierra el men√∫ contextual si se hace clic fuera de √©l
            if (!dom.contextMenu.menu.contains(e.target)) {
                dom.contextMenu.menu.classList.add('hidden');
            }
            // Cierra el picker de emojis si se hace clic fuera de √©l
            if (!dom.media.emojiPicker.contains(e.target) && e.target !== dom.media.emojiBtn) {
                dom.media.emojiPicker.classList.add('hidden');
            }
        });

        dom.media.emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dom.media.emojiPicker.classList.toggle('hidden');
        });

        document.querySelector('emoji-picker').addEventListener('emoji-click', e => {
            dom.chat.input.value += e.detail.unicode;
            dom.media.emojiPicker.classList.add('hidden');
            dom.chat.input.focus();
        });
    </script>
</body>
</html>

    